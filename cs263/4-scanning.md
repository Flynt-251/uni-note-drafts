# Scanning

After we've gone through the formalities of penetration testing, and done our background research, it's time to take a look at what we're up against, so scanning gives us an overview of what machines, services, subdomains and operating systems are available. There are a few different types of scanning, each providing different useful information:

- **Host Discovery** - Who's on the network?
- **Network Tracing** - What does the network look like, what's its topology?
- **Port Scanning** - Are there any services listening for potential clients on the hosts' ports?
- **Version Scanning/OS fingerprinting** - What are the devices on the network? What OSs do they run?
- **Vulnerability Enumeration** - Used once an attacker has a connection to a host. What further vulnerabilities can we exploit?

When we scan a network, we want to do this by IP address, rather than using domain names, since a technique called **round-robin DNS** means that one domain name may be shared by multiple different servers, leading to unnecessary scans. We also need to keep in mind the **subnet** that we're scanning, making sure we know the subnet mask (e.g. 192.168.0.0/8, up to 256 devices). This can go very slowly if we scan all devices, and all possible ports, so tools like **Nmap** will only scan the 1000 most used ports. We also want to make sure we scan using TCP, not UDP, as TCP requires the host to send acknowledgements to the client: we can use this information to determine whether or not we can access a port.

Of course, you need to have made sure you have permission to scan these devices, otherwise your testing device may be blocked: your client should whitelist devices with your IP, to help emulate attacks properly.

While scanning with TCP (scans with UDP are possible, but slower), we can get the following outcomes:

|Attacker Sends...|Target Responds with...|This means...|
|-----------------|-----------------------|-------------|
|`SYN`            |`SYN-ACK`              |Target Port is open and listening.|
|`SYN`            |`RST-ACK`              |Target Port is closed or blocked. |
|`SYN`            |ICMP Port Unreachable  |The firewall blocked this connection.|
|`SYN`            |*silence*              |This port is blocked.|

## Scanning Tools

- **Nmap** - An industry standard network scanning tool, which can scan all open ports on a network, or only common ones, detect firewalls, etc.
  - **Netcat** - Part of Nmap, allowing us to send files between devices, create remote connections, or send a shell.
  - **Nmap Scripting Engine (NSE)** - Can be used to automate network tasks, such as specific types of scan
- **TCPDump** - Packet Analyser library with a CLI and C API.
- **Traceroute** - For network troubleshooting, can ping devices and give exact details about the route taken by packets to reach the destination.
- **Vulnerability Scanners** - Automated scanning tools that can detect network vulnerabilities, giving quick results, but only for known risks. Can give false positives, and not recommended for penetration testing.
  - **Nessus** - Commercial, proprietary scanner that uses pre-configured policies.
  - **OpenVAS** - Open-source scanner that can do authenticated and non-authenticated testing and performance tuning.
- **Wireshark** - Open-source network analyser used by many different businesses, supporting hundreds of protocols, filtering, file capture and even decryption support.

## I C an MP

*Should we pen-test their laptop?*

**Internet Control Message Protocol (ICMP)** provides diagnostic/error messages over IP networks. Below are three common error messages and their causes:

- **Destination Unreachable** - The responding server or gateway can't find the location of the requested destination.
- **Request Timeout** - Not generated by ICMP, but thrown if the destination doesn't respond after a fixed amount of time.
- **Time Exceeded** - Refers to packets' time to live, i.e. the packet(s) travelled too far to reach the destination.
  - Recall that the maximum TTL is 255, and at each hop in a network, this reduces by 1. We can use proxies to reduce "time" taken.

